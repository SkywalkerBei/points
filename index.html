<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†-å®æ—¶</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .meltdown { filter: grayscale(100%) contrast(1.2); transition: all 1s; pointer-events: none; }
        .red-text { color: #ef4444; } 
        .green-text { color: #22c55e; }
        body { background-color: #0d1117; color: #e6edf3; }
        .card { background-color: #161b22; border: 1px solid #30363d; }
    </style>
</head>
<body class="min-h-screen p-4 font-sans" id="main-body">

    <div class="max-w-4xl mx-auto flex justify-between items-end mb-6 card p-6 rounded-xl shadow-2xl">
        <div>
            <h1 class="text-xs text-gray-400 uppercase tracking-widest mb-1">Current Points / å½“å‰ç§¯åˆ†</h1>
            <div class="text-4xl font-black tracking-tighter text-red-500" id="total-points">---</div>
        </div>
        <div class="text-right">
            <div class="text-xs text-green-400 font-mono" id="status">â— æ­£åœ¨è¿æ¥...</div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto card p-4 rounded-xl shadow-lg mb-6">
        <div id="main-chart" style="width: 100%; height: 350px;"></div>
    </div>

    <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="card p-5 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-gray-200 text-lg">æŒ‡ä»¤å½•å…¥</h2>
                <button onclick="toggleMeltdown()" class="text-[10px] border border-red-900 text-red-800 px-2 py-1 rounded hover:bg-red-950">ç†”æ–­</button>
            </div>
            <div class="space-y-3">
                <input id="point-input" type="number" placeholder="å˜åŠ¨æ•°é¢" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <input id="reason-input" type="text" placeholder="åŸå› " class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <select id="mood-input" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                    <option value="ğŸ¥°">ä¸é”™ğŸ‘</option>
                    <option value="ğŸ˜">è¿˜è¡ŒğŸ‘</option>
                    <option value="ğŸ˜’">æ— è¯­ğŸ˜“</option>
                    <option value="ğŸ”¥">ä¸€è¾¹å„¿å»ğŸ’¢</option>
                </select>
                <div class="flex gap-3 pt-2">
                    <button onclick="updatePoints(true)" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg font-black text-white shadow-lg transition-transform active:scale-95">åŠ ä»“ (Reward)</button>
                    <button onclick="updatePoints(false)" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded-lg font-black text-white shadow-lg transition-transform active:scale-95">å‡æŒ (Penalty)</button>
                </div>
            </div>
        </div>

        <div class="card p-5 rounded-xl">
            <h2 class="font-bold text-blue-400 text-lg mb-4">ç›®å½•æ›´æ–°</h2>
            <div class="space-y-3">
                <input id="award-name" type="text" placeholder="å¥–å“åç§°" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-blue-500">
                <input id="award-cost" type="number" placeholder="æ‰€éœ€ç‚¹æ•°" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-blue-500">
                <button onclick="addAward()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-black text-white shadow-lg transition-transform active:scale-95">ä¸Šæ¶æ–°å¥–å“</button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-20">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-3">
            <span class="w-2 h-6 bg-yellow-500 rounded-full"></span>
            å¥–å“å…‘æ¢
        </h2>
        <div id="awards-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const SUPABASE_URL = 'https://usjzwuxdjqbradiypcyb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzanp3dXhkanFicmFkaXlwY3liIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4Nzk4MTgsImV4cCI6MjA4NjQ1NTgxOH0.JGt1KdhxvMFWjZPL_pOdjvlKg1YfpAud7LCvxptcQuM';

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const chart = echarts.init(document.getElementById('main-chart'), 'dark');

        async function init() {
            try {
                await fetchHistory();
                await fetchAwards();
                document.getElementById('status').innerText = 'â— äº¤æ˜“æ‰€å·²è¿æ¥';
            } catch (e) {
                document.getElementById('status').innerText = 'â— è¿æ¥å¼‚å¸¸';
                console.error(e);
            }
        }

        async function fetchHistory() {
            const { data, error } = await db
                .from('points_history')
                .select('*')
                .order('created_at', { ascending: true });

            if (data && data.length > 0) {
                renderChart(data);
                document.getElementById('total-points').innerText = data[data.length - 1].value;
            } else {
                document.getElementById('total-points').innerText = '0';
            }
        }

        async function fetchAwards() {
            const { data } = await db.from('awards').select('*').order('cost', { ascending: true });
            if (data) renderAwards(data);
        }

        function renderChart(data) {
            const option = {
                backgroundColor: 'transparent',
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                tooltip: { 
                    trigger: 'axis',
                    formatter: p => {
                        const d = p[0].data;
                        return `<div class="p-1"><b>${new Date(d.created_at).toLocaleString()}</b><br/>
                                ç§¯åˆ†: <span class="text-red-400">${d.value}</span><br/>
                                åŸå› : ${d.reason}<br/>
                                æƒ…ç»ª: ${d.mood}</div>`
                    }
                },
                xAxis: { 
                    type: 'category', 
                    data: data.map(d => new Date(d.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})),
                    axisLine: { lineStyle: { color: '#30363d' } }
                },
                yAxis: { 
                    type: 'value', 
                    splitLine: { lineStyle: { color: '#30363d' } },
                    axisLine: { show: false }
                },
                series: [{
                    data: data.map(d => ({ value: d.value, created_at: d.created_at, reason: d.reason, mood: d.mood })),
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: { color: '#ef4444', width: 4 },
                    itemStyle: { color: '#ef4444' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(239, 68, 68, 0.4)' },
                            { offset: 1, color: 'rgba(239, 68, 68, 0)' }
                        ])
                    }
                }]
            };
            chart.setOption(option);
        }

        async function updatePoints(isAdd) {
            const valInput = document.getElementById('point-input');
            const reasonInput = document.getElementById('reason-input');
            const val = parseInt(valInput.value);
            const reason = reasonInput.value || 'æ— å¤‡æ³¨äº¤æ˜“';
            const mood = document.getElementById('mood-input').value;
            const currentPoints = parseInt(document.getElementById('total-points').innerText) || 0;

            if (isNaN(val)) return alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é¢');

            const newVal = isAdd ? currentPoints + val : currentPoints - val;
            
            const { error } = await db.from('points_history').insert([
                { value: newVal, reason: reason, mood: mood }
            ]);

            if (!error) {
                valInput.value = '';
                reasonInput.value = '';
                fetchHistory();
            }
        }

        async function addAward() {
            const name = document.getElementById('award-name').value;
            const cost = parseInt(document.getElementById('award-cost').value);
            if (!name || isNaN(cost)) return alert('è¯·å¡«å†™å®Œæ•´å¥–å“ä¿¡æ¯');

            const { error } = await db.from('awards').insert([{ name, cost }]);
            if (!error) {
                document.getElementById('award-name').value = '';
                document.getElementById('award-cost').value = '';
                fetchAwards();
            }
        }

        async function deleteAward(id) {
            if(!confirm('ç¡®å®šè¦ä¸‹æ¶è¯¥å¥–å“å—ï¼Ÿ')) return;
            await db.from('awards').delete().eq('id', id);
            fetchAwards();
        }

        async function redeem(name, cost) {
            const currentPoints = parseInt(document.getElementById('total-points').innerText) || 0;
            if (currentPoints < cost) return alert('ç‚¹æ•°ä¸è¶³ï¼Œæ— æ³•å…‘æ¢è¯¥å¥–å“ï¼');
            
            if (!confirm(`ç¡®å®šè¦æ¶ˆè€— ${cost} ç‚¹å…‘æ¢ "${name}" å—ï¼Ÿ`)) return;

            await db.from('points_history').insert([
                { value: currentPoints - cost, reason: `å…‘æ¢å¥–å“: ${name}`, mood: 'ğŸ' }
            ]);
            fetchHistory();
        }

        function renderAwards(awards) {
            document.getElementById('awards-list').innerHTML = awards.map(a => `
                <div class="card p-4 rounded-xl text-center flex flex-col justify-between">
                    <div>
                        <div class="text-xs text-gray-500 mb-1 font-mono">COST</div>
                        <div class="text-2xl font-black text-yellow-500 mb-1">${a.cost}</div>
                        <div class="text-sm font-bold text-gray-300 mb-4">${a.name}</div>
                    </div>
                    <div class="space-y-2">
                        <button onclick="redeem('${a.name}', ${a.cost})" class="w-full bg-gray-700 hover:bg-yellow-600 text-white text-xs py-2 rounded-lg transition-colors">å…‘æ¢å¥–å“</button>
                        <button onclick="deleteAward(${a.id})" class="w-full text-[10px] text-gray-600 hover:text-red-400">ä¸‹æ¶</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleMeltdown() {
            document.getElementById('main-body').classList.toggle('meltdown');
        }

        // å¯åŠ¨
        init();
        window.onresize = () => chart.resize();
    </script>
</body>
</html>

