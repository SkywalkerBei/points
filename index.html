<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†å®æ—¶</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d1117; color: #e6edf3; transition: filter 0.5s; }
        .card { background-color: #161b22; border: 1px solid #30363d; transition: all 0.3s; }
        .meltdown-active { filter: grayscale(100%) brightness(0.7); }
        .meltdown-active .interactive-card { pointer-events: none; opacity: 0.5; }
        #meltdown-btn { pointer-events: auto !important; position: relative; z-index: 9999; }
        .tab-active { background-color: #ef4444; color: white; font-weight: bold; }
        .tab-inactive { background-color: #30363d; color: #8b949e; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-4 font-sans" id="main-body">

    <div class="max-w-4xl mx-auto flex justify-between items-end mb-6 card p-6 rounded-xl shadow-2xl">
        <div>
            <h1 class="text-xs text-gray-400 uppercase tracking-widest mb-1">Total Assets / è´¦æˆ·æ€»åˆ†</h1>
            <div class="text-4xl font-black tracking-tighter text-red-500" id="total-points">0</div>
        </div>
        <div class="text-right">
            <button onclick="toggleMeltdown()" id="meltdown-btn" class="text-[10px] border border-gray-600 text-gray-500 px-3 py-1 rounded-full hover:border-red-500 hover:text-red-500 transition-all mb-2">ç†”æ–­æ¨¡æ‹Ÿ</button>
            <div class="text-xs text-green-400 font-mono" id="status">â— è¿è¡Œä¸­</div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto flex gap-2 mb-0 px-2">
        <button onclick="changeView('time')" id="btn-time" class="text-xs px-4 py-2 rounded-t-lg tab-active">åˆ†æ—¶</button>
        <button onclick="changeView('day')" id="btn-day" class="text-xs px-4 py-2 rounded-t-lg tab-inactive">æ—¥çº¿</button>
    </div>

    <div class="max-w-4xl mx-auto card p-4 rounded-xl rounded-tl-none shadow-lg mb-6">
        <div id="main-chart" style="width: 100%; height: 380px;"></div>
    </div>

    <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 items-stretch">
        <div class="card p-5 rounded-xl interactive-card flex flex-col">
            <h2 class="font-bold text-gray-200 mb-4">æŒ‡ä»¤ä¸‹è¾¾</h2>
            <div class="space-y-3 flex-grow">
                <input id="point-input" type="number" placeholder="æ•°é¢" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <input id="reason-input" type="text" placeholder="åŸå› è¯´æ˜" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <select id="mood-input" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                    <option value="ğŸ¥°">ä¸é”™ğŸ‘</option>
                    <option value="ğŸ˜">å¯ä»¥ğŸ‘</option>
                    <option value="ğŸ˜’">æ— è¯­ğŸ˜“</option>
                    <option value="ğŸ”¥">ä¸€è¾¹å„¿å»ğŸ’¢</option>
                </select>
                <div class="flex gap-3 pt-1">
                    <button onclick="updatePoints(true)" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg font-black text-white transition-all active:scale-95">å¥–åŠ±</button>
                    <button onclick="updatePoints(false)" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded-lg font-black text-white transition-all active:scale-95">æƒ©ç½š</button>
                </div>
            </div>
        </div>

        <div class="card p-5 rounded-xl interactive-card flex flex-col">
            <h2 class="font-bold text-blue-400 mb-4 text-lg text-white">å¥–å“æ¶</h2>
            <div class="space-y-3 flex-grow flex flex-col">
                <input id="award-name" type="text" placeholder="å¥–å“åç§°" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                <input id="award-cost" type="number" placeholder="æ‰€éœ€ç§¯åˆ†" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                <div class="hidden md:block h-[54px]"></div> 
                <div class="mt-auto pt-1">
                    <button onclick="addAward()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-black text-white transition-all active:scale-95">ä¸Šæ¶æ–°å¥–å“</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-10 interactive-card">
        <div class="flex justify-between items-center mb-4 px-2">
            <h2 class="text-xl font-bold flex items-center gap-3 text-purple-400 font-black">
                <span class="w-1 h-6 bg-purple-500"></span> ç§¯åˆ†æµæ°´æ˜ç»†
            </h2>
            <div class="flex items-center gap-3 bg-gray-800 px-3 py-1 rounded-lg border border-gray-700">
                <button onclick="prevPage()" class="text-xs text-gray-400 hover:text-white disabled:opacity-20" id="prev-btn">â—€</button>
                <span id="page-info" class="text-[10px] font-mono text-purple-300">Page 1</span>
                <button onclick="nextPage()" class="text-xs text-gray-400 hover:text-white disabled:opacity-20" id="next-btn">â–¶</button>
            </div>
        </div>
        <div class="card rounded-xl overflow-hidden overflow-x-auto">
            <table class="w-full text-left text-sm min-w-[500px]">
                <thead class="bg-gray-800/50 text-gray-400">
                    <tr>
                        <th class="p-3 font-bold">æ—¶é—´</th>
                        <th class="p-3 font-bold">å˜åŠ¨</th>
                        <th class="p-3 font-bold">è¯´æ˜</th>
                        <th class="p-3 text-center font-bold">æƒ…ç»ª</th>
                    </tr>
                </thead>
                <tbody id="history-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-20 interactive-card">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-3 text-yellow-500 font-black">
            <span class="w-1 h-6 bg-yellow-500"></span> å¥–å“äº¤æ˜“
        </h2>
        <div id="awards-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://usjzwuxdjqbradiypcyb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzanp3dXhkanFicmFkaXlwY3liIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4Nzk4MTgsImV4cCI6MjA4NjQ1NTgxOH0.JGt1KdhxvMFWjZPL_pOdjvlKg1YfpAud7LCvxptcQuM';

        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const chart = echarts.init(document.getElementById('main-chart'), 'dark');
        
        let rawData = [];
        let currentView = 'time';
        let currentPage = 1;
        const pageSize = 10;

        async function init() {
            await fetchHistory();
            await fetchAwards();
        }

        async function fetchHistory() {
            const { data } = await db.from('points_history').select('*').order('created_at', { ascending: true });
            if (data) { rawData = data; updateUI(); }
        }

        function updateUI() {
            if (rawData.length > 0) {
                document.getElementById('total-points').innerText = rawData[rawData.length - 1].value;
                renderChart();
                renderTable();
            }
        }

        function changeView(view) {
            currentView = view;
            document.getElementById('btn-time').className = view === 'time' ? 'text-xs px-4 py-2 rounded-t-lg tab-active' : 'text-xs px-4 py-2 rounded-t-lg tab-inactive';
            document.getElementById('btn-day').className = view === 'day' ? 'text-xs px-4 py-2 rounded-t-lg tab-active' : 'text-xs px-4 py-2 rounded-t-lg tab-inactive';
            renderChart();
        }

        function renderChart() {
            let displayData = [];
            if (currentView === 'time') {
                displayData = rawData; 
            } else {
                const groups = {};
                rawData.forEach(d => {
                    const date = new Date(d.created_at).toLocaleDateString();
                    groups[date] = d; 
                });
                displayData = Object.values(groups);
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                dataZoom: [{
                    type: 'inside',
                    start: displayData.length > 15 ? 100 - (15 / displayData.length * 100) : 0,
                    end: 100
                }, {
                    type: 'slider',
                    height: 15,
                    bottom: 10,
                    borderColor: 'transparent',
                    fillerColor: 'rgba(239, 68, 68, 0.2)',
                    handleStyle: { color: '#ef4444' }
                }],
                grid: { top: '10%', left: '8%', right: '5%', bottom: '20%' },
                xAxis: { 
                    type: 'category', 
                    data: displayData.map(d => {
                        const dt = new Date(d.created_at);
                        const today = new Date();
                        const isToday = dt.toDateString() === today.toDateString();

                        if (currentView === 'time') {
                            // ä¼˜åŒ–ï¼šè·¨å¤©æ˜¾ç¤ºæ—¥æœŸï¼Œå½“å¤©ä»…æ˜¾ç¤ºæ—¶é—´
                            return isToday ? 
                                `${dt.getHours()}:${dt.getMinutes().toString().padStart(2, '0')}` : 
                                `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${dt.getMinutes().toString().padStart(2, '0')}`;
                        }
                        return `${dt.getMonth()+1}/${dt.getDate()}`;
                    }),
                    axisLabel: { color: '#8b949e', fontSize: 10, hideOverlap: true }
                },
                yAxis: { type: 'value', splitLine: { lineStyle: { color: '#30363d' } } },
                series: [{
                    data: displayData.map(d => d.value),
                    type: currentView === 'time' ? 'line' : 'bar',
                    smooth: true,
                    itemStyle: { color: currentView === 'time' ? '#ef4444' : '#3b82f6' },
                    areaStyle: currentView === 'time' ? { color: 'rgba(239, 68, 68, 0.1)' } : null
                }]
            };
            chart.setOption(option, true);
        }

        function renderTable() {
            const totalPages = Math.ceil(rawData.length / pageSize) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            const reversedData = [...rawData].reverse();
            const startIdx = (currentPage - 1) * pageSize;
            const pageData = reversedData.slice(startIdx, startIdx + pageSize);

            document.getElementById('page-info').innerText = `Page ${currentPage} / ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;

            document.getElementById('history-table-body').innerHTML = pageData.map((item) => {
                const originalIdx = rawData.findIndex(r => r.id === item.id);
                const diff = originalIdx > 0 ? item.value - rawData[originalIdx - 1].value : item.value;
                return `
                    <tr class="border-t border-gray-800">
                        <td class="p-3 text-gray-500 text-xs">${new Date(item.created_at).toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})}</td>
                        <td class="p-3 font-bold ${diff >= 0 ? 'text-red-500' : 'text-green-500'}">${diff > 0 ? '+' : ''}${diff}</td>
                        <td class="p-3 text-gray-300 text-xs">${item.reason}</td>
                        <td class="p-3 text-center">${item.mood}</td>
                    </tr>
                `;
            }).join('');
        }

        function prevPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { if (currentPage < Math.ceil(rawData.length / pageSize)) { currentPage++; renderTable(); } }

        async function updatePoints(isAdd) {
            const val = parseInt(document.getElementById('point-input').value);
            if (isNaN(val)) return alert('è¯·è¾“å…¥æ•°é¢');
            const current = rawData.length > 0 ? rawData[rawData.length - 1].value : 0;
            const newVal = isAdd ? current + val : current - val;
            await db.from('points_history').insert([{ 
                value: newVal, 
                reason: document.getElementById('reason-input').value || 'å¸¸è§„è®°å½•', 
                mood: document.getElementById('mood-input').value 
            }]);
            document.getElementById('point-input').value = '';
            document.getElementById('reason-input').value = '';
            currentPage = 1;
            fetchHistory();
        }

        async function fetchAwards() {
            const { data } = await db.from('awards').select('*').order('cost', { ascending: true });
            if (data) {
                document.getElementById('awards-list').innerHTML = data.map(a => `
                    <div class="card p-4 rounded-xl text-center flex flex-col justify-between border-b-2 border-b-yellow-600">
                        <div>
                            <div class="text-2xl font-black text-yellow-500 mb-1">${a.cost}</div>
                            <div class="text-sm text-gray-300 mb-4">${a.name}</div>
                        </div>
                        <div class="space-y-2">
                            <button onclick="redeem('${a.name}', ${a.cost})" class="w-full bg-yellow-600/10 hover:bg-yellow-600 border border-yellow-600/50 py-2 rounded-lg text-xs transition-all active:scale-95">å…‘æ¢</button>
                            <button onclick="deleteAward(${a.id})" class="text-[10px] text-gray-600 hover:text-red-500 block w-full">ä¸‹æ¶å¥–å“</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function addAward() {
            const name = document.getElementById('award-name').value;
            const cost = parseInt(document.getElementById('award-cost').value);
            if (name && cost) {
                await db.from('awards').insert([{ name, cost }]);
                document.getElementById('award-name').value = '';
                document.getElementById('award-cost').value = '';
                fetchAwards();
            }
        }

        async function deleteAward(id) {
            if (confirm('ç¡®å®šä¸‹æ¶ï¼Ÿ')) { await db.from('awards').delete().eq('id', id); fetchAwards(); }
        }

        async function redeem(name, cost) {
            const current = rawData.length > 0 ? rawData[rawData.length - 1].value : 0;
            if (current < cost) return alert('è¿™ä¹ˆç‚¹ç§¯åˆ†ä¹Ÿæƒ³æ¢ï¼Ÿ');
            if (confirm(`ç¡®å®šèŠ±è´¹ ${cost} å…‘æ¢ [${name}]ï¼Ÿ`)) {
                await db.from('points_history').insert([{ value: current - cost, reason: `å…‘æ¢å¥–å“: ${name}`, mood: 'ğŸ' }]);
                currentPage = 1;
                fetchHistory();
            }
        }

        function toggleMeltdown() {
            const isActive = document.getElementById('main-body').classList.toggle('meltdown-active');
            document.getElementById('meltdown-btn').innerText = isActive ? "è§£é™¤ç†”æ–­" : "ç†”æ–­æ¨¡æ‹Ÿ";
        }

        init();
        window.onresize = () => chart.resize();
    </script>
</body>
</html>
