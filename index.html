<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†å®æ—¶</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .meltdown { filter: grayscale(100%) contrast(1.2); transition: all 1s; pointer-events: none; }
        body { background-color: #0d1117; color: #e6edf3; }
        .card { background-color: #161b22; border: 1px solid #30363d; }
        .tab-active { background-color: #ef4444; color: white; font-weight: bold; }
        .tab-inactive { background-color: #30363d; color: #8b949e; }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-4 font-sans" id="main-body">

    <div class="max-w-4xl mx-auto flex justify-between items-end mb-6 card p-6 rounded-xl shadow-2xl">
        <div>
            <h1 class="text-xs text-gray-400 uppercase tracking-widest mb-1">Total Assets / è´¦æˆ·æ€»åˆ†</h1>
            <div class="text-4xl font-black tracking-tighter text-red-500" id="total-points">0</div>
        </div>
        <div class="text-right">
            <div class="text-xs text-green-400 font-mono" id="status">â— è¿è¡Œä¸­</div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto flex gap-2 mb-0 px-2">
        <button onclick="changeView('time')" id="btn-time" class="text-xs px-4 py-2 rounded-t-lg tab-active">åˆ†æ—¶æ˜ç»† (1D)</button>
        <button onclick="changeView('day')" id="btn-day" class="text-xs px-4 py-2 rounded-t-lg tab-inactive">æ—¥çº¿æ”¶ç›˜ (Daily)</button>
    </div>

    <div class="max-w-4xl mx-auto card p-4 rounded-xl rounded-tl-none shadow-lg mb-6">
        <div id="main-chart" style="width: 100%; height: 350px;"></div>
    </div>

    <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="card p-5 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-gray-200">æŒ‡ä»¤ä¸‹è¾¾</h2>
                <button onclick="document.getElementById('main-body').classList.toggle('meltdown')" class="text-[10px] text-gray-600">ç†”æ–­æ¨¡æ‹Ÿ</button>
            </div>
            <div class="space-y-3">
                <input id="point-input" type="number" placeholder="æ•°é¢" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <input id="reason-input" type="text" placeholder="åŠ å‡åˆ†åŸå› " class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <select id="mood-input" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                    <option value="ğŸ¥°">ä¸é”™ğŸ‘</option>
                    <option value="ğŸ˜">å¯ä»¥ğŸ‘</option>
                    <option value="ğŸ˜’">æ— è¯­ğŸ˜“</option>
                    <option value="ğŸ”¥">ä¸€è¾¹å„¿å»ğŸ’¢</option>
                </select>
                <div class="flex gap-3">
                    <button onclick="updatePoints(true)" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg font-black transition-transform active:scale-95">å¥–åŠ± (Reward)</button>
                    <button onclick="updatePoints(false)" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded-lg font-black transition-transform active:scale-95">æƒ©ç½š (Penalty)</button>
                </div>
            </div>
        </div>

        <div class="card p-5 rounded-xl">
            <h2 class="font-bold text-blue-400 mb-4 text-lg">å¥–å“æ¶</h2>
            <div class="space-y-3">
                <input id="award-name" type="text" placeholder="å¥–å“åç§°" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                <input id="award-cost" type="number" placeholder="æ‰€éœ€ç§¯åˆ†" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                <button onclick="addAward()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-black transition-transform active:scale-95">ä¸Šæ¶æ–°å¥–å“</button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-10">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-3 text-purple-400">
            <span class="w-1 h-6 bg-purple-500"></span> äº¤æ˜“æµæ°´æ˜ç»†
        </h2>
        <div class="card rounded-xl overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-800/50 text-gray-400">
                    <tr>
                        <th class="p-3">æˆäº¤æ—¶é—´</th>
                        <th class="p-3">å˜åŠ¨</th>
                        <th class="p-3">äº¤æ˜“è¯´æ˜</th>
                        <th class="p-3 text-center">æƒ…ç»ª</th>
                    </tr>
                </thead>
                <tbody id="history-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-20">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-3 text-yellow-500">
            <span class="w-1 h-6 bg-yellow-500"></span> å¥–å“äº¤æ˜“
        </h2>
        <div id="awards-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
    </div>

    <script>
        // --- è¯·ç¡®ä¿è¿™é‡Œçš„å‡­è¯æ­£ç¡® ---
        const SUPABASE_URL = 'https://usjzwuxdjqbradiypcyb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzanp3dXhkanFicmFkaXlwY3liIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4Nzk4MTgsImV4cCI6MjA4NjQ1NTgxOH0.JGt1KdhxvMFWjZPL_pOdjvlKg1YfpAud7LCvxptcQuM';

        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const chart = echarts.init(document.getElementById('main-chart'), 'dark');
        let rawData = [];
        let currentView = 'time';

        async function init() {
            await fetchHistory();
            await fetchAwards();
        }

        async function fetchHistory() {
            const { data } = await db.from('points_history').select('*').order('created_at', { ascending: true });
            if (data) {
                rawData = data;
                updateUI();
            }
        }

        function updateUI() {
            if (rawData.length > 0) {
                document.getElementById('total-points').innerText = rawData[rawData.length - 1].value;
                renderChart();
                renderTable();
            }
        }

        function changeView(view) {
            currentView = view;
            document.getElementById('btn-time').className = view === 'time' ? 'text-xs px-4 py-2 rounded-t-lg tab-active' : 'text-xs px-4 py-2 rounded-t-lg tab-inactive';
            document.getElementById('btn-day').className = view === 'day' ? 'text-xs px-4 py-2 rounded-t-lg tab-active' : 'text-xs px-4 py-2 rounded-t-lg tab-inactive';
            renderChart();
        }

        function renderChart() {
            let displayData = [];
            if (currentView === 'time') {
                displayData = rawData;
            } else {
                const groups = {};
                rawData.forEach(d => {
                    const date = new Date(d.created_at).toLocaleDateString();
                    groups[date] = d; // å–å½“å¤©æœ€åä¸€æ¡
                });
                displayData = Object.values(groups);
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                xAxis: { 
                    type: 'category', 
                    data: displayData.map(d => {
                        const dt = new Date(d.created_at);
                        return currentView === 'time' ? `${dt.getHours()}:${dt.getMinutes().toString().padStart(2, '0')}` : `${dt.getMonth()+1}/${dt.getDate()}`;
                    })
                },
                yAxis: { type: 'value', splitLine: { lineStyle: { color: '#30363d' } } },
                series: [{
                    data: displayData.map(d => d.value),
                    type: currentView === 'time' ? 'line' : 'bar',
                    smooth: true,
                    itemStyle: { color: currentView === 'time' ? '#ef4444' : '#3b82f6' },
                    areaStyle: currentView === 'time' ? { color: 'rgba(239, 68, 68, 0.1)' } : null
                }]
            };
            chart.setOption(option, true);
        }

        function renderTable() {
            const list = [...rawData].reverse().slice(0, 15); // æ˜¾ç¤ºæœ€è¿‘15ç¬”
            document.getElementById('history-table-body').innerHTML = list.map((item, idx) => {
                const originalIdx = rawData.findIndex(r => r.id === item.id);
                const diff = originalIdx > 0 ? item.value - rawData[originalIdx - 1].value : item.value;
                const diffClass = diff >= 0 ? 'text-red-500' : 'text-green-500';
                return `
                    <tr class="border-t border-gray-800">
                        <td class="p-3 text-gray-500 text-xs">${new Date(item.created_at).toLocaleString()}</td>
                        <td class="p-3 font-bold ${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                        <td class="p-3 text-gray-300">${item.reason}</td>
                        <td class="p-3 text-center">${item.mood}</td>
                    </tr>
                `;
            }).join('');
        }

        async function updatePoints(isAdd) {
            const val = parseInt(document.getElementById('point-input').value);
            const reason = document.getElementById('reason-input').value || 'æ— å¤‡æ³¨è®°å½•';
            const mood = document.getElementById('mood-input').value;
            if (isNaN(val)) return alert('è¯·è¾“å…¥æ•°é¢');
            
            const current = rawData.length > 0 ? rawData[rawData.length - 1].value : 0;
            const newVal = isAdd ? current + val : current - val;
            
            await db.from('points_history').insert([{ value: newVal, reason, mood }]);
            fetchHistory();
        }

        // --- å¥–å“é€»è¾‘ ---
        async function fetchAwards() {
            const { data } = await db.from('awards').select('*').order('cost', { ascending: true });
            if (data) {
                document.getElementById('awards-list').innerHTML = data.map(a => `
                    <div class="card p-4 rounded-xl text-center">
                        <div class="text-2xl font-black text-yellow-500 mb-1">${a.cost}</div>
                        <div class="text-sm text-gray-300 mb-4">${a.name}</div>
                        <button onclick="redeem('${a.name}', ${a.cost})" class="w-full bg-gray-700 hover:bg-yellow-600 py-2 rounded-lg text-xs transition-colors">å…‘æ¢</button>
                    </div>
                `).join('');
            }
        }

        async function addAward() {
            const name = document.getElementById('award-name').value;
            const cost = parseInt(document.getElementById('award-cost').value);
            if (name && cost) {
                await db.from('awards').insert([{ name, cost }]);
                fetchAwards();
            }
        }

        async function redeem(name, cost) {
            const current = rawData[rawData.length - 1].value;
            if (current < cost) return alert('ç‚¹æ•°ä¸è¶³ï¼');
            if (confirm(`ç¡®å®šæ¶ˆè€— ${cost} ç‚¹å…‘æ¢ ${name}ï¼Ÿ`)) {
                await db.from('points_history').insert([{ value: current - cost, reason: `å…‘æ¢: ${name}`, mood: 'ğŸ' }]);
                fetchHistory();
            }
        }

        init();
        window.onresize = () => chart.resize();
    </script>
</body>
</html>
