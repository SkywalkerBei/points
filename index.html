<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†å®æ—¶</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d1117; color: #e6edf3; transition: filter 0.5s; }
        .card { background-color: #161b22; border: 1px solid #30363d; transition: all 0.3s; }
        .meltdown-active { filter: grayscale(100%) brightness(0.7); }
        .meltdown-active .interactive-card { pointer-events: none; opacity: 0.5; }
        #meltdown-btn { pointer-events: auto !important; position: relative; z-index: 9999; }
        .tab-active { background-color: #ef4444; color: white; font-weight: bold; }
        .tab-inactive { background-color: #30363d; color: #8b949e; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-4 font-sans" id="main-body">

    <div class="max-w-4xl mx-auto flex justify-between items-end mb-6 card p-6 rounded-xl shadow-2xl">
        <div>
            <h1 class="text-xs text-gray-400 uppercase tracking-widest mb-1">Total Assets / è´¦æˆ·æ€»åˆ†</h1>
            <div class="text-4xl font-black tracking-tighter text-red-500" id="total-points">0</div>
        </div>
        <div class="text-right">
            <button onclick="toggleMeltdown()" id="meltdown-btn" class="text-[10px] border border-gray-600 text-gray-500 px-3 py-1 rounded-full hover:border-red-500 hover:text-red-500 transition-all mb-2">ç†”æ–­æ¨¡æ‹Ÿ</button>
            <div class="text-xs text-green-400 font-mono" id="status">â— è¿è¡Œä¸­</div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto flex gap-2 mb-0 px-2">
        <button onclick="changeView('time')" id="btn-time" class="text-xs px-4 py-2 rounded-t-lg tab-active">åˆ†æ—¶æ˜ç»† (æœ€è¿‘å˜åŠ¨)</button>
        <button onclick="changeView('day')" id="btn-day" class="text-xs px-4 py-2 rounded-t-lg tab-inactive">æ—¥çº¿æ”¶ç›˜ (å†å²è¶‹åŠ¿)</button>
    </div>

    <div class="max-w-4xl mx-auto card p-4 rounded-xl rounded-tl-none shadow-lg mb-6">
        <div id="main-chart" style="width: 100%; height: 380px;"></div>
    </div>

    <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="card p-5 rounded-xl interactive-card">
            <h2 class="font-bold text-gray-200 mb-4">æŒ‡ä»¤ä¸‹è¾¾</h2>
            <div class="space-y-3">
                <input id="point-input" type="number" placeholder="æ•°é¢" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <input id="reason-input" type="text" placeholder="åŸå› è¯´æ˜" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                <select id="mood-input" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                    <option value="ğŸ¥°">ä¸é”™ğŸ‘</option>
                    <option value="ğŸ˜">å¯ä»¥ğŸ‘</option>
                    <option value="ğŸ˜’">æ— è¯­ğŸ˜“</option>
                    <option value="ğŸ”¥">ä¸€è¾¹å„¿å»ğŸ’¢</option>
                </select>
                <div class="flex gap-3">
                    <button onclick="updatePoints(true)" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg font-black transition-transform active:scale-95 text-white">å¥–åŠ± (Reward)</button>
                    <button onclick="updatePoints(false)" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded-lg font-black transition-transform active:scale-95 text-white">æƒ©ç½š (Penalty)</button>
                </div>
            </div>
        </div>

        <div class="card p-5 rounded-xl interactive-card">
            <h2 class="font-bold text-blue-400 mb-4 text-lg text-white font-black">å¥–å“æ¶</h2>
            <div class="space-y-3">
                <input id="award-name" type="text" placeholder="å¥–å“åç§°" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                <input id="award-cost" type="number" placeholder="æ‰€éœ€ç§¯åˆ†" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none">
                <button onclick="addAward()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-black transition-transform active:scale-95 text-white">ä¸Šæ¶æ–°å¥–å“</button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-10 interactive-card">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-3 text-purple-400 font-black">
            <span class="w-1 h-6 bg-purple-500"></span> äº¤æ˜“æµæ°´æ˜ç»†
        </h2>
        <div class="card rounded-xl overflow-hidden overflow-x-auto">
            <table class="w-full text-left text-sm min-w-[500px]">
                <thead class="bg-gray-800/50 text-gray-400">
                    <tr>
                        <th class="p-3">æˆäº¤æ—¶é—´</th>
                        <th class="p-3">å˜åŠ¨</th>
                        <th class="p-3">è¯´æ˜</th>
                        <th class="p-3 text-center">æƒ…ç»ª</th>
                    </tr>
                </thead>
                <tbody id="history-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mb-20 interactive-card">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-3 text-yellow-500 font-black">
            <span class="w-1 h-6 bg-yellow-500"></span> å¥–å“äº¤æ˜“åŒº
        </h2>
        <div id="awards-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://usjzwuxdjqbradiypcyb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzanp3dXhkanFicmFkaXlwY3liIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4Nzk4MTgsImV4cCI6MjA4NjQ1NTgxOH0.JGt1KdhxvMFWjZPL_pOdjvlKg1YfpAud7LCvxptcQuM';

        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const chart = echarts.init(document.getElementById('main-chart'), 'dark');
        let rawData = [];
        let currentView = 'time';

        async function init() {
            await fetchHistory();
            await fetchAwards();
        }

        async function fetchHistory() {
            const { data } = await db.from('points_history').select('*').order('created_at', { ascending: true });
            if (data) { rawData = data; updateUI(); }
        }

        function updateUI() {
            if (rawData.length > 0) {
                document.getElementById('total-points').innerText = rawData[rawData.length - 1].value;
                renderChart();
                renderTable();
            }
        }

        function changeView(view) {
            currentView = view;
            document.getElementById('btn-time').className = view === 'time' ? 'text-xs px-4 py-2 rounded-t-lg tab-active' : 'text-xs px-4 py-2 rounded-t-lg tab-inactive';
            document.getElementById('btn-day').className = view === 'day' ? 'text-xs px-4 py-2 rounded-t-lg tab-active' : 'text-xs px-4 py-2 rounded-t-lg tab-inactive';
            renderChart();
        }

        function renderChart() {
            let displayData = [];
            if (currentView === 'time') {
                // ä¼˜åŒ–ç‚¹1ï¼šåˆ†æ—¶å›¾æ˜¾ç¤ºæ‰€æœ‰ç‚¹ï¼Œä½†é»˜è®¤å¼€å¯æ»‘åŠ¨ç¼©æ”¾ï¼Œæˆ–è€…ä½ å¯ä»¥æˆªå–æœ€è¿‘30ä¸ªç‚¹
                displayData = rawData; 
            } else {
                const groups = {};
                rawData.forEach(d => {
                    const date = new Date(d.created_at).toLocaleDateString();
                    groups[date] = d; 
                });
                displayData = Object.values(groups);
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: { 
                    trigger: 'axis',
                    formatter: function (params) {
                        let relVal = params[0].name;
                        relVal += '<br/>ç§¯åˆ†: ' + params[0].value;
                        return relVal;
                    }
                },
                // ä¼˜åŒ–ç‚¹2ï¼šå¼•å…¥ DataZoom ç¼©æ”¾æ¡
                dataZoom: [{
                    type: 'inside', // å…è®¸æ‰‹æŒ‡/é¼ æ ‡æ»šè½®ç¼©æ”¾
                    start: displayData.length > 15 ? 100 - (15 / displayData.length * 100) : 0, // é»˜è®¤æ˜¾ç¤ºæœ€å15ä¸ªç‚¹
                    end: 100
                }, {
                    type: 'slider', // åº•éƒ¨æ˜¾ç¤ºæ»‘åŠ¨æ¡
                    height: 20,
                    bottom: 10,
                    borderColor: 'transparent',
                    fillerColor: 'rgba(239, 68, 68, 0.2)',
                    handleStyle: { color: '#ef4444' }
                }],
                grid: { top: '10%', left: '10%', right: '5%', bottom: '20%' },
                xAxis: { 
                    type: 'category', 
                    data: displayData.map(d => {
                        const dt = new Date(d.created_at);
                        const isToday = dt.toDateString() === new Date().toDateString();
                        // ä¼˜åŒ–ç‚¹3ï¼šå¦‚æœä¸æ˜¯ä»Šå¤©çš„ç‚¹ï¼Œåœ¨åˆ†æ—¶å›¾é‡Œä¹Ÿæ˜¾ç¤ºæ—¥æœŸ
                        if (currentView === 'time') {
                            return isToday ? 
                                `${dt.getHours()}:${dt.getMinutes().toString().padStart(2, '0')}` : 
                                `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${dt.getMinutes().toString().padStart(2, '0')}`;
                        }
                        return `${dt.getMonth()+1}/${dt.getDate()}`;
                    }),
                    axisLabel: { color: '#8b949e', fontSize: 10 }
                },
                yAxis: { 
                    type: 'value', 
                    splitLine: { lineStyle: { color: '#30363d' } },
                    axisLabel: { color: '#8b949e' }
                },
                series: [{
                    data: displayData.map(d => d.value),
                    type: currentView === 'time' ? 'line' : 'bar',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 6,
                    itemStyle: { color: currentView === 'time' ? '#ef4444' : '#3b82f6' },
                    areaStyle: currentView === 'time' ? {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(239, 68, 68, 0.5)' },
                            { offset: 1, color: 'rgba(239, 68, 68, 0)' }
                        ])
                    } : null
                }]
            };
            chart.setOption(option, true);
        }

        function renderTable() {
            const list = [...rawData].reverse().slice(0, 15);
            document.getElementById('history-table-body').innerHTML = list.map((item) => {
                const originalIdx = rawData.findIndex(r => r.id === item.id);
                const diff = originalIdx > 0 ? item.value - rawData[originalIdx - 1].value : item.value;
                return `
                    <tr class="border-t border-gray-800">
                        <td class="p-3 text-gray-500 text-xs">${new Date(item.created_at).toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})}</td>
                        <td class="p-3 font-bold ${diff >= 0 ? 'text-red-500' : 'text-green-500'}">${diff > 0 ? '+' : ''}${diff}</td>
                        <td class="p-3 text-gray-300 text-xs">${item.reason}</td>
                        <td class="p-3 text-center">${item.mood}</td>
                    </tr>
                `;
            }).join('');
        }

        async function updatePoints(isAdd) {
            const valBox = document.getElementById('point-input');
            const reasonBox = document.getElementById('reason-input');
            const val = parseInt(valBox.value);
            const reason = reasonBox.value || 'æ—¥å¸¸è®°å½•';
            const mood = document.getElementById('mood-input').value;
            if (isNaN(val)) return alert('è¯·è¾“å…¥æ•°é¢');
            
            const current = rawData.length > 0 ? rawData[rawData.length - 1].value : 0;
            const newVal = isAdd ? current + val : current - val;
            
            await db.from('points_history').insert([{ value: newVal, reason, mood }]);
            valBox.value = ''; reasonBox.value = '';
            fetchHistory();
        }

        async function fetchAwards() {
            const { data } = await db.from('awards').select('*').order('cost', { ascending: true });
            if (data) {
                document.getElementById('awards-list').innerHTML = data.map(a => `
                    <div class="card p-4 rounded-xl text-center flex flex-col justify-between border-b-2 border-b-yellow-900">
                        <div>
                            <div class="text-2xl font-black text-yellow-500 mb-1">${a.cost}</div>
                            <div class="text-sm text-gray-300 mb-4">${a.name}</div>
                        </div>
                        <div class="space-y-2">
                            <button onclick="redeem('${a.name}', ${a.cost})" class="w-full bg-yellow-600/20 hover:bg-yellow-600 border border-yellow-600 py-2 rounded-lg text-xs transition-colors text-yellow-500 hover:text-white">å…‘æ¢</button>
                            <button onclick="deleteAward(${a.id})" class="text-[10px] text-gray-600 hover:text-red-500 block w-full text-center">ä¸‹æ¶</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function addAward() {
            const name = document.getElementById('award-name').value;
            const cost = parseInt(document.getElementById('award-cost').value);
            if (name && cost) {
                await db.from('awards').insert([{ name, cost }]);
                document.getElementById('award-name').value = '';
                document.getElementById('award-cost').value = '';
                fetchAwards();
            }
        }

        async function deleteAward(id) {
            if (confirm('ç¡®å®šè¦ä¸‹æ¶è¿™ä¸ªå¥–å“å—ï¼Ÿ')) {
                await db.from('awards').delete().eq('id', id);
                fetchAwards();
            }
        }

        async function redeem(name, cost) {
            const current = rawData.length > 0 ? rawData[rawData.length - 1].value : 0;
            if (current < cost) return alert('ä½™é¢ä¸è¶³ï¼Œå†æ¥å†å‰ï¼');
            if (confirm(`ç¡®å®šèŠ±è´¹ ${cost} åˆ†å…‘æ¢ [${name}] å—ï¼Ÿ`)) {
                await db.from('points_history').insert([{ value: current - cost, reason: `å…‘æ¢å¥–å“: ${name}`, mood: 'ğŸ' }]);
                fetchHistory();
            }
        }

        function toggleMeltdown() {
            const body = document.getElementById('main-body');
            const btn = document.getElementById('meltdown-btn');
            const isActive = body.classList.toggle('meltdown-active');
            btn.innerText = isActive ? "è§£é™¤ç†”æ–­" : "ç†”æ–­æ¨¡æ‹Ÿ";
        }

        init();
        window.onresize = () => chart.resize();
    </script>
</body>
</html>
